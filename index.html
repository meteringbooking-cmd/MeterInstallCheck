<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Meter QC System</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
    :root {
        --primary: #0066FF;
        --primary-dark: #0052CC;
        --success: #00C853;
        --danger: #FF3D00;
        --warning: #FFB300;
        --bg: #0A0E27;
        --surface: #151932;
        --surface-light: #1E2340;
        --text: #E8EAED;
        --text-dim: #9BA3AF;
        --border: #2A2F4A;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Outfit', sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        overflow-x: hidden;
    }
    
    /* Animated background */
    body::before {
        content: '';
        position: fixed;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: 
            radial-gradient(circle at 20% 50%, rgba(0, 102, 255, 0.08) 0%, transparent 50%),
            radial-gradient(circle at 80% 80%, rgba(0, 200, 83, 0.06) 0%, transparent 50%),
            radial-gradient(circle at 40% 20%, rgba(255, 61, 0, 0.04) 0%, transparent 50%);
        animation: drift 30s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
    }
    
    @keyframes drift {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        33% { transform: translate(30px, -30px) rotate(1deg); }
        66% { transform: translate(-20px, 20px) rotate(-1deg); }
    }
    
    .container {
        position: relative;
        z-index: 1;
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px;
    }
    
    /* Header */
    header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 60px;
        padding-bottom: 30px;
        border-bottom: 1px solid var(--border);
    }
    
    .logo {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .logo-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary), var(--success));
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 20px;
    }
    
    .logo h1 {
        font-size: 24px;
        font-weight: 700;
        letter-spacing: -0.5px;
    }
    
    .mode-switcher {
        display: flex;
        gap: 8px;
        background: var(--surface);
        padding: 4px;
        border-radius: 12px;
        border: 1px solid var(--border);
    }
    
    .mode-btn {
        padding: 10px 20px;
        border: none;
        background: transparent;
        color: var(--text-dim);
        font-family: 'Outfit', sans-serif;
        font-size: 14px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .mode-btn.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(0, 102, 255, 0.3);
    }
    
    .mode-btn:not(.active):hover {
        color: var(--text);
    }
    
    /* Main Content */
    .content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
    }
    
    @media (max-width: 968px) {
        .content {
            grid-template-columns: 1fr;
        }
    }
    
    .panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 32px;
        position: relative;
        overflow: hidden;
    }
    
    .panel::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--success));
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .panel:hover::before {
        opacity: 1;
    }
    
    .panel-header {
        margin-bottom: 24px;
    }
    
    .panel-header h2 {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
    }
    
    .panel-header p {
        color: var(--text-dim);
        font-size: 14px;
    }
    
    /* Upload Zone */
    .upload-zone {
        border: 2px dashed var(--border);
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        background: var(--surface-light);
    }
    
    .upload-zone:hover {
        border-color: var(--primary);
        background: rgba(0, 102, 255, 0.05);
    }
    
    .upload-zone.dragover {
        border-color: var(--primary);
        background: rgba(0, 102, 255, 0.1);
        transform: scale(1.02);
    }
    
    .upload-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto 16px;
        background: var(--surface);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
    }
    
    .upload-zone h3 {
        font-size: 16px;
        margin-bottom: 8px;
        font-weight: 600;
    }
    
    .upload-zone p {
        color: var(--text-dim);
        font-size: 13px;
    }
    
    .file-input {
        display: none;
    }
    
    /* Image Preview */
    .image-preview-container {
        margin: 24px 0;
        border-radius: 16px;
        overflow: hidden;
        background: var(--bg);
        border: 1px solid var(--border);
        position: relative;
        display: none;
    }
    
    .image-preview-container.active {
        display: block;
    }
    
    .image-preview {
        width: 100%;
        height: auto;
        max-height: 400px;
        object-fit: contain;
        display: block;
    }
    
    .image-overlay {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 8px;
    }
    
    .overlay-btn {
        background: rgba(10, 14, 39, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border);
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        font-family: 'Outfit', sans-serif;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    
    .overlay-btn:hover {
        background: rgba(10, 14, 39, 0.95);
        transform: translateY(-2px);
    }
    
    /* Annotation Canvas */
    .annotation-container {
        position: relative;
        display: none;
    }
    
    .annotation-container.active {
        display: block;
    }
    
    .annotation-canvas {
        position: absolute;
        top: 0;
        left: 0;
        cursor: crosshair;
        border-radius: 16px;
    }
    
    .annotation-tools {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        padding: 16px;
        background: var(--surface-light);
        border-radius: 12px;
        border: 1px solid var(--border);
    }
    
    .color-picker {
        display: flex;
        gap: 8px;
    }
    
    .color-option {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .color-option:hover {
        transform: scale(1.1);
    }
    
    .color-option.active {
        border-color: white;
        box-shadow: 0 0 0 2px var(--bg);
    }
    
    .annotation-input {
        flex: 1;
        background: var(--bg);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 10px 16px;
        border-radius: 8px;
        font-family: 'Outfit', sans-serif;
        font-size: 14px;
    }
    
    .annotation-input::placeholder {
        color: var(--text-dim);
    }
    
    .annotation-input:focus {
        outline: none;
        border-color: var(--primary);
    }
    
    /* Buttons */
    .btn {
        padding: 14px 28px;
        border: none;
        border-radius: 12px;
        font-family: 'Outfit', sans-serif;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }
    
    .btn:hover::before {
        width: 300px;
        height: 300px;
    }
    
    .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 16px rgba(0, 102, 255, 0.3);
    }
    
    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 102, 255, 0.4);
    }
    
    .btn-primary:disabled {
        background: var(--border);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .btn-success {
        background: var(--success);
        color: white;
        box-shadow: 0 4px 16px rgba(0, 200, 83, 0.3);
    }
    
    .btn-success:hover {
        background: #00B04A;
        transform: translateY(-2px);
    }
    
    .btn-danger {
        background: var(--danger);
        color: white;
        box-shadow: 0 4px 16px rgba(255, 61, 0, 0.3);
    }
    
    .btn-danger:hover {
        background: #E63500;
        transform: translateY(-2px);
    }
    
    .btn-secondary {
        background: var(--surface-light);
        color: var(--text);
        border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
        background: var(--border);
    }
    
    .btn-group {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }
    
    /* Results */
    .results {
        margin-top: 24px;
        padding: 24px;
        background: var(--surface-light);
        border-radius: 16px;
        border: 1px solid var(--border);
        min-height: 120px;
        display: none;
    }
    
    .results.active {
        display: block;
    }
    
    .results-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }
    
    .status-badge {
        padding: 6px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        font-family: 'JetBrains Mono', monospace;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-badge.good {
        background: rgba(0, 200, 83, 0.2);
        color: var(--success);
        border: 1px solid var(--success);
    }
    
    .status-badge.bad {
        background: rgba(255, 61, 0, 0.2);
        color: var(--danger);
        border: 1px solid var(--danger);
    }
    
    .status-badge.analyzing {
        background: rgba(0, 102, 255, 0.2);
        color: var(--primary);
        border: 1px solid var(--primary);
    }
    
    .results-content {
        color: var(--text);
        line-height: 1.6;
        font-size: 14px;
    }
    
    /* Loading Spinner */
    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Training History */
    .training-history {
        margin-top: 24px;
    }
    
    .training-item {
        background: var(--surface-light);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        display: flex;
        gap: 16px;
        align-items: start;
        transition: all 0.3s ease;
    }
    
    .training-item:hover {
        border-color: var(--primary);
        transform: translateX(4px);
    }
    
    .training-thumb {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        object-fit: cover;
        background: var(--bg);
    }
    
    .training-details {
        flex: 1;
    }
    
    .training-details h4 {
        font-size: 14px;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .training-details p {
        font-size: 13px;
        color: var(--text-dim);
        margin-bottom: 8px;
    }
    
    .training-notes {
        font-size: 12px;
        color: var(--text);
        background: var(--bg);
        padding: 8px 12px;
        border-radius: 6px;
        font-family: 'JetBrains Mono', monospace;
    }
    
    /* Hidden elements */
    .hidden {
        display: none !important;
    }
    
    /* Compliance Mode Specific */
    #compliance-section {
        display: none;
    }
    
    #compliance-section.active {
        display: block;
    }
    
    #analysis-section.active {
        display: block;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .container {
            padding: 20px 16px;
        }
        
        header {
            flex-direction: column;
            gap: 20px;
            text-align: center;
        }
        
        .btn-group {
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
        }
    }
</style>
</head>
<body>
<div class="container">
    <header>
        <div class="logo">
            <div class="logo-icon">‚ö°</div>
            <h1>Smart Meter QC</h1>
        </div>
        <div class="mode-switcher">
            <button class="mode-btn active" data-mode="analysis">Analysis</button>
            <button class="mode-btn" data-mode="compliance">Compliance Training</button>
        </div>
    </header>

    <!-- ANALYSIS MODE -->
    <div id="analysis-section" class="active">
        <div class="content">
            <div class="panel">
                <div class="panel-header">
                    <h2>Upload Installation Photo</h2>
                    <p>Drop an image or click to select a smart meter installation</p>
                </div>
                
                <div class="upload-zone" id="analysis-upload-zone">
                    <div class="upload-icon">üì∏</div>
                    <h3>Click or drag image here</h3>
                    <p>Supports JPG, PNG, WebP (max 10MB)</p>
                    <input type="file" class="file-input" id="analysis-file-input" accept="image/*">
                </div>
                
                <div class="image-preview-container" id="analysis-preview-container">
                    <img class="image-preview" id="analysis-preview" alt="Preview">
                    <div class="image-overlay">
                        <button class="overlay-btn" id="analysis-remove">‚úï Remove</button>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" id="analyze-btn" disabled>
                        <span>üîç Analyze Installation</span>
                    </button>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <h2>Analysis Results</h2>
                    <p>AI-powered quality assessment</p>
                </div>
                
                <div class="results" id="analysis-results">
                    <div class="results-header">
                        <div class="status-badge analyzing">Analyzing...</div>
                    </div>
                    <div class="spinner"></div>
                </div>
                
                <div id="analysis-placeholder" style="padding: 40px; text-align: center; color: var(--text-dim);">
                    <div style="font-size: 48px; margin-bottom: 16px;">ü§ñ</div>
                    <p>Upload an image to begin analysis</p>
                </div>
            </div>
        </div>
    </div>

    <!-- COMPLIANCE TRAINING MODE -->
    <div id="compliance-section">
        <div class="content">
            <div class="panel">
                <div class="panel-header">
                    <h2>Upload Training Image</h2>
                    <p>Add examples to improve the system's accuracy</p>
                </div>
                
                <div class="upload-zone" id="compliance-upload-zone">
                    <div class="upload-icon">üìã</div>
                    <h3>Click or drag image here</h3>
                    <p>Supports JPG, PNG, WebP (max 10MB)</p>
                    <input type="file" class="file-input" id="compliance-file-input" accept="image/*">
                </div>
                
                <div class="image-preview-container" id="compliance-preview-container">
                    <img class="image-preview" id="compliance-preview" alt="Preview">
                    <div class="image-overlay">
                        <button class="overlay-btn" id="compliance-remove">‚úï Remove</button>
                    </div>
                    <div class="annotation-container" id="annotation-container">
                        <canvas class="annotation-canvas" id="annotation-canvas"></canvas>
                    </div>
                </div>
                
                <div class="annotation-tools hidden" id="annotation-tools">
                    <div class="color-picker">
                        <div class="color-option active" data-color="#FF3D00" style="background: #FF3D00;"></div>
                        <div class="color-option" data-color="#FFB300" style="background: #FFB300;"></div>
                        <div class="color-option" data-color="#0066FF" style="background: #0066FF;"></div>
                    </div>
                    <input type="text" class="annotation-input" id="annotation-text" placeholder="Describe the issue...">
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" id="mark-good-btn" disabled>‚úì Mark as Good</button>
                    <button class="btn btn-danger" id="mark-bad-btn" disabled>‚úó Mark as Bad</button>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <h2>Training History</h2>
                    <p>Recent submissions</p>
                </div>
                
                <div class="training-history" id="training-history">
                    <div style="padding: 40px; text-align: center; color: var(--text-dim);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìö</div>
                        <p>No training data yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// State Management
const state = {
    currentMode: 'analysis',
    analysis: {
        file: null,
        base64: null,
        mimeType: null
    },
    compliance: {
        file: null,
        base64: null,
        mimeType: null,
        annotations: [],
        isAnnotating: false,
        currentColor: '#FF3D00'
    },
    trainingHistory: []
};

// Mode Switching
document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const mode = btn.dataset.mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        document.getElementById('analysis-section').classList.remove('active');
        document.getElementById('compliance-section').classList.remove('active');
        document.getElementById(`${mode}-section`).classList.add('active');
        
        state.currentMode = mode;
    });
});

// Drag and Drop Handler
function setupDragDrop(zone, input) {
    zone.addEventListener('click', () => input.click());
    
    zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
    });
    
    zone.addEventListener('dragleave', () => {
        zone.classList.remove('dragover');
    });
    
    zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            handleFileSelect(file, state.currentMode);
        }
    });
}

// File Selection Handler
function handleFileSelect(file, mode) {
    if (!file.type.startsWith('image/')) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 1024;
            const scale = Math.min(1, MAX_WIDTH / img.width);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            const base64 = canvas.toDataURL(file.type).split(',')[1];
            
            if (mode === 'analysis') {
                state.analysis.file = file;
                state.analysis.base64 = base64;
                state.analysis.mimeType = file.type;
                document.getElementById('analysis-preview').src = canvas.toDataURL(file.type);
                document.getElementById('analysis-preview-container').classList.add('active');
                document.getElementById('analyze-btn').disabled = false;
                document.getElementById('analysis-placeholder').style.display = 'none';
            } else {
                state.compliance.file = file;
                state.compliance.base64 = base64;
                state.compliance.mimeType = file.type;
                document.getElementById('compliance-preview').src = canvas.toDataURL(file.type);
                document.getElementById('compliance-preview-container').classList.add('active');
                document.getElementById('mark-good-btn').disabled = false;
                document.getElementById('mark-bad-btn').disabled = false;
                setupAnnotationCanvas(canvas.toDataURL(file.type));
            }
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// Setup Upload Zones
setupDragDrop(document.getElementById('analysis-upload-zone'), document.getElementById('analysis-file-input'));
setupDragDrop(document.getElementById('compliance-upload-zone'), document.getElementById('compliance-file-input'));

document.getElementById('analysis-file-input').addEventListener('change', (e) => {
    if (e.target.files[0]) handleFileSelect(e.target.files[0], 'analysis');
});

document.getElementById('compliance-file-input').addEventListener('change', (e) => {
    if (e.target.files[0]) handleFileSelect(e.target.files[0], 'compliance');
});

// Remove Buttons
document.getElementById('analysis-remove').addEventListener('click', () => {
    state.analysis = { file: null, base64: null, mimeType: null };
    document.getElementById('analysis-preview-container').classList.remove('active');
    document.getElementById('analyze-btn').disabled = true;
    document.getElementById('analysis-file-input').value = '';
});

document.getElementById('compliance-remove').addEventListener('click', () => {
    state.compliance = { file: null, base64: null, mimeType: null, annotations: [], isAnnotating: false, currentColor: '#FF3D00' };
    document.getElementById('compliance-preview-container').classList.remove('active');
    document.getElementById('mark-good-btn').disabled = true;
    document.getElementById('mark-bad-btn').disabled = true;
    document.getElementById('compliance-file-input').value = '';
    document.getElementById('annotation-tools').classList.add('hidden');
});

// Analysis Function
document.getElementById('analyze-btn').addEventListener('click', async () => {
    if (!state.analysis.base64) return;
    
    const resultsDiv = document.getElementById('analysis-results');
    const placeholder = document.getElementById('analysis-placeholder');
    
    resultsDiv.innerHTML = `
        <div class="results-header">
            <div class="status-badge analyzing">Analyzing...</div>
        </div>
        <div class="spinner"></div>
    `;
    resultsDiv.classList.add('active');
    placeholder.style.display = 'none';
    
    try {
        const response = await fetch('http://localhost:3000/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    role: "user",
                    parts: [
                        { text: "Analyze this smart meter installation. Determine if it is 'Good' or 'Bad'. Provide specific details about installation quality, safety compliance, and any issues." },
                        { inlineData: { mimeType: state.analysis.mimeType, data: state.analysis.base64 } }
                    ]
                }],
                systemInstruction: { 
                    parts: [{ text: "You are an expert smart meter quality control inspector. Provide clear, concise assessments of installation quality. Start your response with either 'Good' or 'Bad', then explain your reasoning." }] 
                }
            })
        });
        
        const data = await response.json();
        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "Unable to analyze image.";
        
        const isGood = /^good/i.test(text.trim());
        const isBad = /^bad/i.test(text.trim());
        
        resultsDiv.innerHTML = `
            <div class="results-header">
                <div class="status-badge ${isGood ? 'good' : isBad ? 'bad' : 'analyzing'}">${isGood ? 'GOOD' : isBad ? 'BAD' : 'ANALYZED'}</div>
            </div>
            <div class="results-content">${text}</div>
        `;
    } catch (error) {
        resultsDiv.innerHTML = `
            <div class="results-header">
                <div class="status-badge bad">ERROR</div>
            </div>
            <div class="results-content">Failed to analyze image. Please check your connection and try again.</div>
        `;
    }
});

// Annotation Canvas Setup
function setupAnnotationCanvas(imageSrc) {
    const container = document.getElementById('annotation-container');
    const canvas = document.getElementById('annotation-canvas');
    const preview = document.getElementById('compliance-preview');
    
    preview.onload = () => {
        canvas.width = preview.width;
        canvas.height = preview.height;
        canvas.style.width = preview.width + 'px';
        canvas.style.height = preview.height + 'px';
    };
    
    let isDrawing = false;
    let startX, startY;
    
    canvas.addEventListener('mousedown', (e) => {
        if (!state.compliance.isAnnotating) return;
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing || !state.compliance.isAnnotating) return;
        const rect = canvas.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;
        
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Redraw existing annotations
        state.compliance.annotations.forEach(ann => {
            ctx.strokeStyle = ann.color;
            ctx.lineWidth = 3;
            ctx.strokeRect(ann.x, ann.y, ann.width, ann.height);
        });
        
        // Draw current rectangle
        ctx.strokeStyle = state.compliance.currentColor;
        ctx.lineWidth = 3;
        ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
    });
    
    canvas.addEventListener('mouseup', (e) => {
        if (!isDrawing || !state.compliance.isAnnotating) return;
        isDrawing = false;
        const rect = canvas.getBoundingClientRect();
        const endX = e.clientX - rect.left;
        const endY = e.clientY - rect.top;
        
        const annotation = {
            x: startX,
            y: startY,
            width: endX - startX,
            height: endY - startY,
            color: state.compliance.currentColor,
            note: ''
        };
        
        state.compliance.annotations.push(annotation);
    });
}

// Color Picker
document.querySelectorAll('.color-option').forEach(option => {
    option.addEventListener('click', () => {
        document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
        option.classList.add('active');
        state.compliance.currentColor = option.dataset.color;
    });
});

// Mark as Bad (Enable Annotation)
document.getElementById('mark-bad-btn').addEventListener('click', () => {
    state.compliance.isAnnotating = true;
    document.getElementById('annotation-container').classList.add('active');
    document.getElementById('annotation-tools').classList.remove('hidden');
    
    // Change button to submit
    const badBtn = document.getElementById('mark-bad-btn');
    badBtn.textContent = 'üíæ Submit Training Data';
    badBtn.onclick = submitTrainingData;
});

// Mark as Good
document.getElementById('mark-good-btn').addEventListener('click', async () => {
    await submitTrainingData(true);
});

// Submit Training Data
async function submitTrainingData(isGood = false) {
    const notes = isGood ? 'Good installation' : document.getElementById('annotation-text').value;
    
    const trainingData = {
        image: state.compliance.base64,
        mimeType: state.compliance.mimeType,
        classification: isGood ? 'good' : 'bad',
        notes: notes,
        annotations: state.compliance.annotations,
        timestamp: new Date().toISOString()
    };
    
    try {
        const response = await fetch('http://localhost:3000/training', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(trainingData)
        });
        
        if (response.ok) {
            // Add to history
            state.trainingHistory.unshift(trainingData);
            updateTrainingHistory();
            
            // Reset
            document.getElementById('compliance-remove').click();
            alert('Training data submitted successfully!');
        }
    } catch (error) {
        alert('Failed to submit training data.');
    }
}

// Update Training History Display
function updateTrainingHistory() {
    const historyDiv = document.getElementById('training-history');
    
    if (state.trainingHistory.length === 0) {
        historyDiv.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--text-dim);">
                <div style="font-size: 48px; margin-bottom: 16px;">üìö</div>
                <p>No training data yet</p>
            </div>
        `;
        return;
    }
    
    historyDiv.innerHTML = state.trainingHistory.map(item => `
        <div class="training-item">
            <img src="data:${item.mimeType};base64,${item.image}" class="training-thumb" alt="Training image">
            <div class="training-details">
                <h4>
                    <span class="status-badge ${item.classification}">${item.classification.toUpperCase()}</span>
                    <span style="color: var(--text-dim); font-size: 12px; font-weight: 400;">${new Date(item.timestamp).toLocaleString()}</span>
                </h4>
                <p>${item.annotations.length} annotation(s)</p>
                ${item.notes ? `<div class="training-notes">${item.notes}</div>` : ''}
            </div>
        </div>
    `).join('');
}

// Load training history on startup
fetch('http://localhost:3000/training-history')
    .then(res => res.json())
    .then(data => {
        state.trainingHistory = data;
        updateTrainingHistory();
    })
    .catch(() => {});
</script>
</body>
</html>
